<html>
	<head>
		<title>Minesweeper</title>
		<style>
			button {
				width: 76px;
				border-style: solid
			}

			body {
				display: flex;
				align-items: center;
				justify-content: center;
				height: 100%;
				margin: 0px;
			}

			/* difficulty selection */
			.trivial {
				border-color: darkcyan;
				background-color: cyan;
			}
			.easy {
				border-color: green;
				background-color: lime;
			}
			.medium {
				border-color: olive;
				background-color: yellow;
			}
			.hard {
				border-color: #b05000;
				background-color: orange;
			}
			.expert {
				border-color: darkred;
				background-color: red/*rgb(255, 15, 15)*/;
			}
			.custom {
				border-color: darkblue;
				background-color: blue/*rgb(23, 23, 255)*/;
			}

			/* custom game */
			input { border-style: solid }
			.custom_setting {
				display: inline;
				padding-top: 15px
			}

			/* game stuff */
			#board {
				display: grid;
				grid-template-columns: 26px;
			}
			.tile {
				width: 20px;
				height: 20px;
				border-style: solid;
				border-color: rgb(64, 64, 64);
				background-color: lightgray;
				font-weight: bold;
				font-family: Sans-serif, monospace;
				display: flex;
				justify-content: center;
				align-items: center;
				user-select: none
			}
			.unrevealed { background-color: gray }
			.unrevealed.flagged { color: darkred }
			._-1 { background-color: red }
			._1 { color: blue }
			._2 { color: green }
			._3 { color: red }
			._4 { color: purple }
			._5 { color: black }
			._6 { color: gray }
			._7 { color: maroon }
			._8 { color: turquoise }
		</style>
		<!-- https://github.com/Taureon/MinesweeperGenerator -->
		<script type="text/javascript">
			let generateMap = (width = 9, height = 6, mines = 15) => {

				//make sure the values selected arent too broken
				if (width < 1) width = 1;
				if (height < 1) height = 1;
				while (mines > width * height) mines = width * height;

				//generate empty map
				var temp = ()=>Array(height).fill(0);
				var map = Array(width).fill(temp).map(f => f());

				//spawn mines
				var x = 0,
					y = 0,
					i = 0;
				while (i < mines) {
					x = Math.floor(Math.random() * width);
					y = Math.floor(Math.random() * height);
					if (!map[x][y]) {
						i++;
						map[x][y] = -1;
					}
				}

				function tileIsAMine(x, y) {
					if (x === -1 || y === -1 || x === width || y === height) return false;
					return map[x][y] === -1;
				}

				//add mine counters
				for (x = 0; x < width; x++) {
					for (y = 0; y < height; y++) {
						if (!map[x][y]) {
							//this seems dumb, but it works!
							[-1, 0, 1].forEach((a) => {
								[-1, 0, 1].forEach((b) => {
									map[x][y] += tileIsAMine(x - a, y - b);
								});
							});
						}
					}
				}

				return map;
			};
		</script>
		<script type="text/javascript">
			let map, updateTile, getSurroundingTiles;
			
			const setDiff = async diff => {
				let width, height, mines, diff_div = document.getElementById("diff_div");
				switch (diff) {
					case 0:
						diff = "Trivial";
						width = 8;
						height = 7;
						mines = 7;
						break;

					case 1:
						diff = "Easy";
						width = 11;
						height = 8;
						mines = 10;
						break;

					case 2:
						diff = "Medium";
						width = 13;
						height = 9;
						mines = 12;
						break;

					case 3:
						diff = "Hard";
						width = 15;
						height = 10;
						mines = 16;
						break;

					case 4:
						diff = "Expert";
						width = 17;
						height = 11;
						mines = 21;
						break;

					case 5:
						diff = "Random";

						//generate random with/height from 8 to 17
						width = 8 + Math.floor(Math.random() * 8);
						height = 8 + Math.floor(Math.random() * 8);

						//average width and height and round
						mines = Math.round((width + height) / 2);
						break;

					default:
						diff = "Custom";
						await new Promise(Resolve => {
								
								//switch menus to the custom game settings one
								diff_div.remove();
								document.getElementsByTagName("h1").innerText = "Choose your custom game parameters:"
								document.getElementById("custom_div").hidden=false;

								//this is garbage but functional garbage
								document.getElementById("custom_play").onclick = ()=> {
									//css grids
									width = parseInt(document.getElementById("height").value),
									height = parseInt(document.getElementById("width").value),
									mines = parseInt(document.getElementById("mines").value)
									Resolve();
								};
						});

				}

				//css grids, go to hell
				[width, height] = [height, width];

				if (diff_div) diff_div.remove();
				document.getElementById("custom_div").remove();
				document.getElementsByTagName("title")[0].innerText += " - " + diff;

				//game starts here
				map = generateMap(width, height, mines).map((column, x) => column.map((tile, y) => {

					let tempDiv = document.createElement('div');

					tempDiv.classList.add("tile", "unrevealed");
					tempDiv.id = `tile_${x}_${y}`;

					tempDiv.addEventListener('click', event => {
						let [, x, y] = event.target.id.split('_');
						updateTile(parseInt(x), parseInt(y), 0);
					});

					tempDiv.addEventListener("contextmenu", event => {
						event.preventDefault();
						let [, x, y] = event.target.id.split('_');
						updateTile(parseInt(x), parseInt(y), 1);
					});

					return {
						mines: tile,
						x, y,
						div: tempDiv
					};
				}));

				let board = document.getElementById('board');

				map.forEach(column => column.forEach(tile => board.appendChild(tile.div)));

				board.style["grid-template-columns"] += " 26px".repeat(map[0].length);

				board.parentElement.hidden = false;

				getSurroundingTiles = (x, y) => {
					let offsets = [
						{x: x - 1, y: y - 1},
						{x: x	 , y: y - 1},
						{x: x + 1, y: y - 1},

						{x: x - 1, y: y    },
						{x: x + 1, y: y    },

						{x: x - 1, y: y + 1},
						{x: x	 , y: y + 1},
						{x: x + 1, y: y + 1} 
					];

					let tiles = [];

					for (offset of offsets) {

						//if in bounds, else ignore
						if (offset.x > -1
						 && offset.y > -1
						 && offset.x < map.length
						 && offset.y < map[0].length
						) tiles.push(map[offset.x][offset.y]);
					}

					return tiles;
				},

				updateTile = (x, y, mode) => {

					let tile = map[x][y];

					switch(mode) {

						//reveal tile
						case 0:
							if (tile.div.classList.contains('flagged')) break;

							if (!tile.div.classList.contains('unrevealed')) {
								let flags = 0,
									tiles = getSurroundingTiles(x, y).filter(nearTile => nearTile.div.classList.contains('unrevealed'));

								//if as many flagged tiles are around it as the amount of mines surround it 
								tiles.forEach(nearTile => nearTile.div.classList.contains('flagged') && flags++);
								if (flags === tile.mines) tiles.forEach(nearTile => updateTile(nearTile.x, nearTile.y, 0));

								break;
							}

							tile.div.classList.add("_" + tile.mines);
							tile.div.classList.remove("unrevealed");

							if (tile.mines === -1) {
								//lose
							} else {

								if (tile.mines > 0) {
									tile.div.innerText = tile.mines;
									break;
								}

								getSurroundingTiles(x, y).forEach(nearTile => {

									//if unrevealed, reveal it
									if (nearTile.div.classList.contains('unrevealed')) updateTile(nearTile.x, nearTile.y, 0);
								});
							}

							break;

						//flag tile
						case 1:

							//if right clicking an unrevealed tile, just flag it
							if (tile.div.classList.contains('unrevealed')) {
								//browser displays "⚑" as "âš‘" instead, and using a html code fixes that
								tile.div.innerHTML = tile.div.classList.toggle('flagged') ? "&#9873;" : "";
								break;

							} else {
							
								//if right clicking a cleared tile, get all uncleared tiles around it
								let tiles = getSurroundingTiles(x, y).filter(nearTile => nearTile.div.classList.contains('unrevealed'));

								//if as many unrevealed tiles as there are mines around it, flag all unflagged tiles
								if (tile.mines !== tiles.length) break;
								tiles
								.filter(nearTile => !nearTile.div.classList.contains('flagged'))
								.forEach(nearTile => updateTile(nearTile.x, nearTile.y, 1));

							}
							
							break;
							
					}

					map[x][y] = tile;
				},
				
				//if user gets stuck
				//i am adding this because i dont want to make the minesweeper map gen fool proof
				help = () => {
				};
			};

			//make the random button a random color
			window.onload=()=>{
				let randomButton = document.getElementsByClassName("random")[0],
					hue = Math.floor(Math.random() * 100);
				randomButton.style["background-color"] = `hsl(${hue}, 100%, 50%)`;
				randomButton.style["border-color"] = `hsl(${hue}, 100%, 25%)`;
			};
		</script>
	</head>
	<body>
		<div id="diff_div">
			<h1>Choose your game difficulty:</h1>
			<button class="trivial" onclick="setDiff(0)">Trivial</button>
			<button class="easy" onclick="setDiff(1)">Easy</button>
			<button class="medium" onclick="setDiff(2)">Medium</button>
			<button class="hard" onclick="setDiff(3)">Hard</button>
			<button class="expert" onclick="setDiff(4)">Expert</button>
			<p style="font-size:20"></p>
			<button class="random" onclick="setDiff(5)">Random</button>
			<button class="custom" onclick="setDiff(8008135)">Custom</button>
		</div>

		<div hidden id="custom_div">
			<p class="custom_setting">width:</p>
			<input style="display:block" id="width" type="number" value="8"></input>
			<p class="custom_setting">height:</p>
			<input style="display:block" id="height" type="number" value="8"></input>
			<p class="custom_setting">mines:</p>
			<input style="display:block" id="mines" type="number" value="8"></input>
			<p style="font-size:10"></p>
			<button id="custom_play">Play custom game</button>	
		</div>

		<div hidden id="game_div">
			<div id="board"></div>
			<button onclick="help()">Stuck? (WIP)</button>
		</div>
	</body>
</html>
